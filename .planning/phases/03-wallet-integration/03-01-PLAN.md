---
phase: 03-wallet-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - front-end/src/components/providers/wallet-provider.tsx
  - front-end/src/components/providers/app-providers.tsx
autonomous: true

must_haves:
  truths:
    - "Wallet context is accessible from any component via useWallet hook"
    - "Leather wallet connection flow works on testnet/mainnet"
    - "Devnet wallet selection state is managed in context"
    - "Connection state persists across page refreshes (via @stacks/connect localStorage)"
  artifacts:
    - path: "front-end/src/components/providers/wallet-provider.tsx"
      provides: "WalletProvider context and useWallet hook"
      exports: ["WalletProvider", "useWallet"]
      min_lines: 80
    - path: "front-end/src/components/providers/app-providers.tsx"
      provides: "AppProviders with wallet integration"
      contains: "WalletProvider"
  key_links:
    - from: "wallet-provider.tsx"
      to: "@stacks/connect"
      via: "import { connect, disconnect, isConnected, getLocalStorage }"
      pattern: "connect|disconnect|isConnected|getLocalStorage"
    - from: "wallet-provider.tsx"
      to: "lib/devnet-wallet-context.ts"
      via: "import { DevnetWallet, devnetWallets }"
      pattern: "DevnetWallet|devnetWallets"
    - from: "app-providers.tsx"
      to: "wallet-provider.tsx"
      via: "WalletProvider in provider tree"
      pattern: "<WalletProvider>"
---

<objective>
Create unified wallet context provider that manages both Leather (testnet/mainnet) and devnet wallet connections.

Purpose: Provide centralized wallet state management accessible to all components via useWallet hook. This is the foundation for all wallet UI components.

Output: WalletProvider component integrated into AppProviders, exposing connection state, addresses, and wallet actions.
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-wallet-integration/03-RESEARCH.md
@.planning/phases/03-wallet-integration/03-CONTEXT.md

# Existing code to reference
@front-end/src/components/_deprecated-chakra/HiroWalletProvider.tsx
@front-end/src/components/_deprecated-chakra/DevnetWalletProvider.tsx
@front-end/src/lib/devnet-wallet-context.ts
@front-end/src/lib/networks.ts
@front-end/src/components/providers/app-providers.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified WalletProvider context</name>
  <files>front-end/src/components/providers/wallet-provider.tsx</files>
  <action>
Create a unified wallet provider that handles both Leather (testnet/mainnet) and devnet connections.

**Interface (WalletContextType):**
```typescript
interface WalletContextType {
  // Connection state
  isConnected: boolean
  isConnecting: boolean

  // User data
  address: string | null
  network: NetworkType

  // Actions
  connectWallet: () => Promise<void>
  disconnectWallet: () => void

  // Devnet specific
  isDevnet: boolean
  devnetWallet: DevnetWallet | null
  setDevnetWallet: (wallet: DevnetWallet | null) => void
}
```

**Implementation requirements:**

1. Add "use client" directive (uses browser APIs)

2. Get network from environment: `process.env.NEXT_PUBLIC_NETWORK || "devnet"` as NetworkType

3. For Leather connection (testnet/mainnet):
   - Use Promise-based `connect()` from @stacks/connect (NOT deprecated callback API)
   - After connect, call `isConnected()` to verify
   - Get address from `getLocalStorage()?.addresses?.stx?.[0]?.address`
   - Handle connection errors with try/catch, log to console

4. For devnet:
   - Store selected wallet in state (DevnetWallet | null)
   - When devnetWallet is set, isConnected = true, address = devnetWallet.stxAddress
   - On disconnect, set devnetWallet to null

5. On mount (useEffect):
   - Check `isConnected()` for Leather state restoration
   - If connected, load address from `getLocalStorage()`
   - Use mounted state pattern to prevent hydration issues

6. Export:
   - `WalletProvider` component
   - `useWallet` hook (useContext with null check)

**Reference deprecated HiroWalletProvider.tsx for v8.x @stacks/connect patterns.**

**Do NOT:**
- Use deprecated `showConnect()` or callback-based API
- Import from @stacks/connect-react (deprecated)
- Expect multiple addresses from getLocalStorage (v8.x returns only current network)
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd front-end && pnpm tsc --noEmit
```
File exists and exports WalletProvider and useWallet.
  </verify>
  <done>
wallet-provider.tsx exists with WalletProvider and useWallet exports. TypeScript compiles. Context interface includes all required fields: isConnected, isConnecting, address, network, connectWallet, disconnectWallet, isDevnet, devnetWallet, setDevnetWallet.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate WalletProvider into AppProviders</name>
  <files>front-end/src/components/providers/app-providers.tsx</files>
  <action>
Update AppProviders to include WalletProvider in the provider tree.

**Provider nesting order (established in 01-04):**
```
QueryClientProvider (outermost - data layer)
  └─ ThemeProvider (theming layer)
      └─ WalletProvider (wallet layer)
          └─ children (app content)
```

**Changes:**
1. Import WalletProvider from "./wallet-provider"
2. Remove the TODO comments about Phase 3
3. Wrap children with WalletProvider inside ThemeProvider:

```tsx
<QueryClientProvider client={queryClient}>
  <ThemeProvider ...>
    <WalletProvider>
      {children}
    </WalletProvider>
  </ThemeProvider>
</QueryClientProvider>
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd front-end && pnpm tsc --noEmit
```
Dev server starts without errors:
```bash
cd front-end && timeout 10 pnpm dev || true
```
  </verify>
  <done>
AppProviders imports WalletProvider and nests it inside ThemeProvider. TODO comments removed. Build and dev server work without errors.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `pnpm tsc --noEmit` passes in front-end directory
2. `pnpm dev` starts without runtime errors
3. WalletProvider is in provider tree (visible in React DevTools if needed)
4. useWallet hook can be called from any client component
</verification>

<success_criteria>
- WalletProvider exports WalletContext with all required fields
- useWallet hook exported and throws if used outside provider
- AppProviders wraps children with WalletProvider
- Network defaults to devnet when NEXT_PUBLIC_NETWORK not set
- TypeScript compiles without errors
- Dev server starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-wallet-integration/03-01-SUMMARY.md`
</output>
