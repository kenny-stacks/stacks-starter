---
phase: 08-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - clarity/tests/counter.test.ts
autonomous: false

must_haves:
  truths:
    - "All Vitest tests pass with Clarity 4 configuration"
    - "Counter contract has dedicated test coverage"
    - "Contract deploys to local devnet and functions correctly"
  artifacts:
    - path: "clarity/tests/counter.test.ts"
      provides: "Counter contract test coverage"
      exports: []
      min_lines: 30
  key_links:
    - from: "clarity/tests/counter.test.ts"
      to: "clarity/contracts/counter.clar"
      via: "simnet.callPublicFn('counter', ...)"
      pattern: "callPublicFn.*counter"
---

<objective>
Validate Clarity 4 migration by testing all contracts and verifying devnet deployment.

Purpose: Confirm the Clarity 4 configuration works correctly across all validation layers (unit tests + devnet).
Output: Counter test file with full coverage, verified devnet deployment.
</objective>

<execution_context>
@/Users/kenny/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kenny/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-validation/08-RESEARCH.md
@clarity/tests/fundraising.test.ts
@clarity/contracts/counter.clar
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create counter contract tests</name>
  <files>clarity/tests/counter.test.ts</files>
  <action>
Create comprehensive test file for counter.clar following the pattern established in fundraising.test.ts.

Test cases to cover:
1. `get-count` returns initial value of 0
2. `increment` increases counter by 1 and returns new value
3. `increment` can be called multiple times
4. `decrement` decreases counter by 1 and returns new value
5. `decrement` fails with err-underflow (err u1) when counter is 0

Structure:
- Import from vitest, @stacks/transactions (Cl), and @hirosystems/clarinet-sdk (initSimnet)
- Initialize simnet and get deployer account
- Use describe block for "counter contract"
- Each test should be self-contained (simnet state resets per test file run)

Use `.toBeOk()` and `.toBeErr()` matchers from clarinet-sdk vitest helpers.
For multiple increments test, call increment sequentially and verify final value.

Note: Do NOT test underflow recovery (decrement from 0 then increment) in same test - would require state reset.
  </action>
  <verify>
Run `cd clarity && npm test` - all tests pass including new counter tests.
Run `cd clarity && npm run test:report` - counter.clar shows coverage > 0%.
  </verify>
  <done>
- counter.test.ts exists with 5+ test cases
- All tests pass (including fundraising tests)
- Counter contract has test coverage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify devnet deployment</name>
  <what-built>
Counter contract running on Clarity 4 with test coverage.
Devnet deployment should work identically to pre-migration.
  </what-built>
  <how-to-verify>
1. Ensure Docker Desktop is running
2. In terminal 1, start devnet:
   ```bash
   cd clarity && clarinet devnet start
   ```
3. Wait for contracts to deploy (~block 45, watch terminal output)
4. Verify contracts deployed successfully in terminal output:
   - Look for "counter" contract deployment
   - Look for "fundraising" contract deployment
5. Open Stacks Explorer at http://localhost:8000
6. Navigate to deployed contracts, confirm counter contract exists
7. (Optional) In terminal 2, start frontend:
   ```bash
   pnpm --filter front-end dev
   ```
8. Open http://localhost:3000 and test:
   - Counter displays 0
   - Click Increment - counter becomes 1
   - Click Decrement - counter returns to 0
9. Stop devnet with Ctrl+C when done
  </how-to-verify>
  <resume-signal>Type "approved" if devnet test passes, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `cd clarity && npm test` - all tests pass (11+ tests)
2. `cd clarity && npm run test:report` - counter.clar has coverage
3. Devnet deployment verified manually
4. Contract functions correctly (increment/decrement work)
</verification>

<success_criteria>
- TST-01: All Vitest tests pass (11 fundraising + 5+ counter tests)
- TST-02: Contract deploys and functions on devnet (manually verified)
- TST-03: N/A - no Clarity 4 features adopted (per Phase 7 decision)
- Counter contract has test coverage (was 0% before this plan)
</success_criteria>

<output>
After completion, create `.planning/phases/08-validation/08-01-SUMMARY.md`
</output>
